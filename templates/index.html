<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Drone Simulator Dashboard</title>

    <!-- SocketIO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <!-- Leaflet for map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0; padding: 0;
            background: #f0f2f5;
        }
        header {
            background: #34495e;
            color: white;
            padding: 12px 20px;
            text-align: center;
        }
        main {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            padding: 15px;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            margin: 10px;
        }
        #video-container img {
            max-width: 960px;
            border-radius: 10px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: center;
        }
        th {
            background: #34495e;
            color: white;
        }
        #map {
            width: 100%;
            height: 400px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
<header>
    <h1>Drone Simulator Dashboard</h1>
</header>
<main>
    <div class="card" id="video-container">
        <h2>Live Video with Detections</h2>
        <img id="live-frame" src="" alt="Waiting for frames...">
    </div>

    <div class="card" id="telemetry-container">
        <h2>Telemetry Table</h2>
        <table>
            <thead>
                <tr>
                    <th>Frame ID</th>
                    <th>Latitude</th>
                    <th>Longitude</th>
                    <th>Altitude</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody id="telemetry-body"></tbody>
        </table>
    </div>

    <div class="card" id="map-container">
        <h2>Drone Live Map</h2>
        <div id="map"></div>
    </div>
</main>

<script>
const socket = io({transports: ['websocket']});

// Initialize Leaflet map
const map = L.map('map').setView([28.6139, 77.2090], 17); // starting at Delhi
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Map data Â© OpenStreetMap contributors'
}).addTo(map);

// Marker for drone
let droneMarker = L.marker([28.6139, 77.2090]).addTo(map);

socket.on('connect', () => console.log("Connected to server"));

socket.on('new_detection', data => {
    // Update video
    if (data.img) {
        document.getElementById('live-frame').src = data.img + "?t=" + new Date().getTime();
    }

    // Update telemetry table
    const tbody = document.getElementById('telemetry-body');
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${data.frame_id}</td>
        <td>${data.telemetry.lat.toFixed(6)}</td>
        <td>${data.telemetry.lon.toFixed(6)}</td>
        <td>${data.telemetry.alt.toFixed(2)}</td>
        <td>${new Date(data.timestamp*1000).toLocaleTimeString()}</td>
    `;
    tbody.prepend(row);
    while (tbody.rows.length > 20) tbody.deleteRow(-1);

    // Update map
    if(data.telemetry.lat && data.telemetry.lon){
        droneMarker.setLatLng([data.telemetry.lat, data.telemetry.lon]);
        map.setView([data.telemetry.lat, data.telemetry.lon]);
    }
});
</script>
</body>
</html>
